#!/bin/python
import getopt
import sys
import json

import requests

section = "languages"
exclude_langs: list[str] = []
include_langs: list[str] = []

use_real_total = 0

milestones = [50]

api = ""
user = ""

top = -1

valid_ranges=[
    "today",
    "yesterday",
    "week",
    "month",
    "year",
    "last_7_days",
    "7_days",
    "last_30_days",
    "30_days",
    "last_6_months",
    "6_months",
    "last_12_months",
    "12_months",
    "last_year",
    "any",
    "all_time"
]

used_range = "any"

def gen_help():
    print("""lang-stats [Tprxiaut] [percentage...]
        Use wakapi to print language/project usage stats

        OPTIONS:
        u <user>   : the user to print stats for
        t <number> : display the top <number> languages/projects
        p          : print project times instead of language times
        r <range>  : time range, one of:
        $(printf '\t\t  %s\n' "${valid_ranges[@]}")
        x <names>  : exclude a ',' separated list of languages/projects
                     can be used multiple times.
                     Mutually exclusive with -i
        i <names>  : Similar to -x but ONLY show the languages listed with -i
                     Mutually exclusive with -x
        T          : When using -x or -i,
                     use the complete total seconds for the percentage instead
                     of only the total seconds of included langs/projects
        a <domain> : use <domain> as the api url base

        ARGUMENTS:
        percentage... :
                    each arg is treated as a percentage to print to label how many
                    languages are needed to add up to that percentage.
""")

args = sys.argv
opts, args = getopt.getopt(args[1:], "hTpr:x:i:a:u:t:")

for opt, optarg in opts:
    match opt[1:]:
        case "t":
            top = int(optarg)
        case "p":
            section = optarg
        case "r":
            used_range = optarg
            if used_range not in valid_ranges:
                print(f"Not a valid range: {used_range} setting back to any",
                      file=sys.stderr)
        case "T":
            use_real_total = 1
        case "x":
            include_langs = []
            exclude_langs += [k.strip().lower() for k in optarg.split(",")]
        case 'i':
            exclude_langs = []
            include_langs += [k.strip().lower() for k in optarg.split(",")]
        case 'a':
            api = optarg
        case 'u':
            user = optarg
        case 'h':
            gen_help()

if not api:
    print("No api url given", file=sys.stderr)
    exit(1)

if not user:
    print("No user given", file=sys.stderr)
    exit(1)

def convertsecs(secs: int):
    h = secs // 3600
    m = (secs % 3600) // 60
    s = secs % 60
    return f"{h:02d}:{m:02d}:{s:02d}"

def lang_counter():
    langs_included = 0

    def include_lang(lang: str):
        nonlocal langs_included

        lang = lang.lower()

        if top > 0 and langs_included > top:
            return False

        langs_included += 1

        if exclude_langs and lang in exclude_langs:
            return False

        if include_langs and lang in include_langs:
            return True

        return True

    return include_lang

if args:
    milestones = [float(k) for k in args]

raw = requests.get(f"{api}/api/compat/wakatime/v1/users/{user}/stats/{used_range}")

raw = raw.json()
# print(json.dumps(raw))

day_count = raw["data"]["days_including_holidays"] + 1

data = raw["data"][section]

time_total = day_count * 86400

total_secs_included = 0

include = lang_counter()
for item in data:
    name = item["name"]
    if not include(name):
        continue
    total_secs_included += item["total_seconds"]


total_pct = 0
total_secs = 0
milestones = iter(milestones)
cur_milestone = next(milestones)
lang_count = 0

include = lang_counter()

for item in data:
    name = item["name"]
    if not include(name): continue

    secs = item["total_seconds"]

    if not use_real_total:
        pct = secs / total_secs_included * 100
    else:
        pct = item["percent"]

    total_pct += pct

    total_secs += secs
    lang_count += 1

    print(f"{name} {convertsecs(secs)} ({pct:.02f})")

    while cur_milestone > 0 and total_pct > cur_milestone:
        print(f"\x1b[1m{cur_milestone}%-({lang_count}) {convertsecs(total_secs)} ({total_pct:.2f}%)\x1b[0m")
        cur_milestone = next(milestones, -1)
print(f"--------------\nTOTAL: {convertsecs(total_secs)} ({total_pct:.02f}%)")
print(f"--------------\nAVG {convertsecs(round(total_secs / time_total * 86400))} time/day\n")
