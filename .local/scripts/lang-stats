#!/bin/python
import getopt
import sys
import json

import requests

section = "languages"
exclude_langs: list[str] = []
include_langs: list[str] = []

use_real_total = 0

milestones: list[float | int] = [50]

time_milestones: list[str] = []

api = ""
user = ""

top = -1

ansi_enabled = sys.stdout.isatty()

valid_ranges=[
    "today",
    "yesterday",
    "week",
    "month",
    "year",
    "last_7_days",
    "7_days",
    "last_30_days",
    "30_days",
    "last_6_months",
    "6_months",
    "last_12_months",
    "12_months",
    "last_year",
    "any",
    "all_time"
]

used_range = "any"

def gen_help():
    print("""lang-stats [TprxiautAe] [percentage...]
        Use wakapi to print language/project usage stats

        OPTIONS:
        u <user>   : the user to print stats for
        t <number> : display the top <number> languages/projects
        p          : print project times instead of language times
        r <range>  : time range, one of:
        $(printf '\t\t  %s\n' "${valid_ranges[@]}")
        x <names>  : exclude a ',' separated list of languages/projects
                     can be used multiple times.
                     Mutually exclusive with -i
        i <names>  : Similar to -x but ONLY show the languages listed with -i
                     Mutually exclusive with -x
        T          : When using -x or -i,
                     use the complete total seconds for the percentage instead
                     of only the total seconds of included langs/projects
        a <domain> : use <domain> as the api url base
        A          : disbale ansi sequences
                     (automatically disabled when stdout is not a terminal)
        e          : enable ansi sequences

        ARGUMENTS:
        percentage... :
                    each arg is treated as a percentage to print to label how many
                    languages are needed to add up to that percentage.
""")

args = sys.argv
opts, args = getopt.getopt(args[1:], "hTpr:x:i:a:u:t:Ae")

for opt, optarg in opts:
    match opt[1:]:
        case "t":
            top = int(optarg)
        case "p":
            section = "projects"
        case "r":
            used_range = optarg
            shortcuts = {
                    "t": "today",
                    "w": "week",
                    "m": "month",
                    "30": "last_30_days",
            }
            used_range = shortcuts.get(used_range, used_range)

            if used_range not in valid_ranges:
                print(f"Not a valid range: {used_range} setting back to any",
                      file=sys.stderr)
        case "T":
            use_real_total = 1
        case "x":
            include_langs = []
            exclude_langs += [k.strip().lower() for k in optarg.split(",")]
        case 'i':
            exclude_langs = []
            include_langs += [k.strip().lower() for k in optarg.split(",")]
        case 'a':
            api = optarg
        case 'u':
            user = optarg
        case 'e':
            ansi_enabled = 1
        case 'A':
            ansi_enabled = 0
        case 'h':
            gen_help()
        case INVALID:
            print(f"Invalid option {INVALID}", file=sys.stderr)
            exit(1)

if not api:
    print("No api url given", file=sys.stderr)
    exit(1)

if not user:
    print("No user given", file=sys.stderr)
    exit(1)

def convertsecs(secs: int):
    h = secs // 3600
    m = (secs % 3600) // 60
    s = secs % 60
    return f"{h:02d}:{m:02d}:{s:02d}"

def time2secs(time: str):
    hours, mins, secs = time.split(":")
    return int(hours) * 3600 + int(mins) * 60 + int(secs)

def lang_counter():
    langs_included = 0

    def include_lang(lang: str):
        nonlocal langs_included

        lang = lang.lower()

        if top > 0 and langs_included > top:
            return False

        langs_included += 1

        if exclude_langs and lang in exclude_langs:
            return False
        elif exclude_langs:
            return True

        if include_langs and lang in include_langs:
            return True
        elif include_langs:
            return False

        return True

    return include_lang

if args:
    milestones = []
    time_milestones = []
    for arg in args:
        if ":" in arg:
            time_milestones.append(arg)
        else:
            milestones.append(float(arg))

raw = requests.get(f"{api}/api/compat/wakatime/v1/users/{user}/stats/{used_range}")

raw = raw.json()
# print(json.dumps(raw))

day_count = raw["data"]["days_including_holidays"] + 1

data = raw["data"][section]

time_total = day_count * 86400

total_secs_included = 0

include = lang_counter()
for item in data:
    name = item["name"]
    if not include(name):
        continue
    total_secs_included += item["total_seconds"]


total_pct = 0
total_secs = 0

milestones_iter = iter(sorted(milestones))
cur_milestone = next(milestones_iter, -1)

time_milestones_iter = iter(sorted(time_milestones, key=time2secs))
cur_time_milestone = next(time_milestones_iter, "")

lang_count = 0

include = lang_counter()

def print_line_item(name: str, time: str, pct: float, *, clr="35"):
    text = f"\x1b[{clr}m{name}\x1b[0m" if ansi_enabled else name
    text += f" {time} ({pct:.2f}%)"
    text += "\x1b[0m" if ansi_enabled else ""
    print(text)

for i, item in enumerate(data):
    name = item["name"]
    if not include(name): continue

    secs = item["total_seconds"]

    if not use_real_total:
        pct = secs / total_secs_included * 100
    else:
        pct = item["percent"]

    total_pct += pct

    total_secs += secs
    lang_count += 1

    print_line_item(name, convertsecs(secs), pct, clr=f"3{i + 1}" if i < 6 else '0')

    while cur_milestone > 0 and total_pct > cur_milestone:
        print_line_item(f"{cur_milestone}%-({lang_count})", convertsecs(total_secs), total_pct, clr="35;1")
        # print(f"\x1b[1m{cur_milestone}%-({lang_count}) {convertsecs(total_secs)} ({total_pct:.2f}%)\x1b[0m")
        cur_milestone = next(milestones_iter, -1)

    while cur_time_milestone and total_secs > time2secs(cur_time_milestone):
        print_line_item(f"{cur_time_milestone}-({lang_count})", convertsecs(total_secs), total_pct, clr="95")
        # print(f"\x1b[1m{cur_time_milestone}-({lang_count}) {convertsecs(total_secs)} ({total_pct:.2f}%)\x1b[0m")
        cur_time_milestone = next(time_milestones_iter, "")

print(f"--------------\nTOTAL: {convertsecs(total_secs)} ({total_pct:.02f}%)")
print(f"--------------\nAVG {convertsecs(round(total_secs / time_total * 86400))} time/day\n")
